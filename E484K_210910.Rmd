---
title: "E484K_210910"
author: "Lily Zhong"
date: "4/24/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Load Packages

```{r load packages, message = FALSE}
# data manipulation
library(tidyverse)
library(stringr)
library(lubridate)
# phylogenetic
library(ape)
library(phytools)
library(castor)
library(phangorn)
# plotting
library(ggplot2)
library(ggpubr)
library(ggExtra)
library(gridExtra)
library(RColorBrewer)
# statistical testing
library(corrplot)
```


### Import data

#### NextStrain Subsample Tree

```{r import NextStrain Subsample Tree}
# read in the tree
tree <- read.tree("nextstrain_timetree_210910.nwk")

# check basics
length(tree$tip.label) # 3449 tree tip labels = 3449 samples
summary(tree$edge.length)
#     Min.    1st Qu.   Median     Mean     3rd Qu.     Max.
# -0.001012  0.026966  0.070278  0.120726  0.166907  1.342243
sum(tree$edge.length < 0) # 9 edges has negative lengths
sum(tree$edge.length == 0) # 257 edges has negative lengths
is.rooted(tree) # TRUE
is.binary(tree) # FALSE: not fully resolved
```

#### NextClade Variant Calling

```{r import NextStrain Subsample NextClade Variant Calling}
# read in the NextClade csv
sequence <- read_csv2("nextclade_210910.csv")

# check basics
dim(sequence) # (3442, 63) -- missing sequences for 7/3449 of tree tips/samples

# arrange information: 
sequence <- sequence %>% 
            select(seqName, clade, Nextclade_pango, aaSubstitutions, aaDeletions) %>% 
            # merge non-synonymous substitutions with deletions
            mutate(mutation = ifelse(is.na(aaDeletions),
                                     aaSubstitutions, 
                                     paste(aaSubstitutions, aaDeletions, sep = ","))) %>% 
            # assign SARS-CoV-2 variants to sequences
            mutate(variant = case_when(clade %in% c("19A", "19B", "20A", "20B", "20C", "20D", 
                                                    "20E (EU1)", "20F", "20G") ~ "other",
                                       clade == "20I (Alpha, V1)" ~ "Alpha",
                                       clade == "20H (Beta, V2)" ~ "Beta",
                                       clade == "20J (Gamma, V3)" ~ "Gamma",
                                       clade == "21A (Delta)" ~ "Delta",
                                       clade == "21B (Kappa)" ~ "Kappa",
                                       clade == "21C (Epsilon)" ~ "Epsilon",
                                       clade == "21D (Eta)" ~ "Eta",
                                       clade == "21F (Iota)" ~ "Iota",
                                       clade == "21G (Lambda)" ~ "Lambda",
                                       clade == "21H (Mu)" ~ "Mu",
                                       clade == "21I (Delta)" ~ "Delta",
                                       clade == "21J (Delta)" ~ "Delta"))
```

#### Patient Metadata

```{r import NextStrain Subsample Patient Metadata}
# problem(read_tsv("nextstrain_patient_meta_210910.tsv"))
# format of `Collection date` at line 208 (2021-05-7) and line 2401 (2021-06-1) is wrong
# change to line 208 (2021-05-07) and line 2401 (2021-06-01) in the .tsv file
# read in the metadata tsv
meta <- read_tsv("nextstrain_patient_meta_210910.tsv")

# check basics
dim(meta) # (3442, 17) -- missing sequences for 7/3449 of tree tips/samples
```


### Match sequence names with tree tip names & remove tree tips with no sequence or meta info

```{r Match Sequence Names with Tree Tip Names}
# step 1: extract parts of sequence labels that have the same pattern as the tree tip label
sequence <- sequence %>% 
            mutate(GISAID_ID = seqName) %>% # GISAID_ID for backup
            mutate(seqName = str_extract(.$seqName, "hCoV-19/.+/.+/\\d{4}")) %>% # tree tip
            mutate(Accession_ID = GISAID_ID) %>% 
            mutate(Accession_ID = str_extract(.$Accession_ID, "EPI_ISL_\\d*")) %>% # meta
            select(GISAID_ID, seqName, Accession_ID, variant, mutation)
# check 1
length(intersect(tree$tip.label, sequence$seqName)) # 3449 matches
# find names only in tree tip label
only_tree <- data.frame(tree_lab = setdiff(tree$tip.label, sequence$seqName))
only_tree <- only_tree %>% arrange(tree_lab)
# dim(only_tree) # 539
# find names only in sequence label
only_seq <- sequence %>%
            mutate(seq_lab = seqName) %>%
            select(seq_lab, GISAID_ID) %>%
            # keep GISAID_ID to match back to the sequence data set later
            filter(seq_lab %in% setdiff(sequence$seqName, tree$tip.label)) %>%
            # only in sequence label
            arrange(seq_lab)
# dim(only_seq) # (532, 2)
# add NAs so that the dim matches
only_seq[533:539, ] <- NA
dim(only_seq) # (539, 2)
mismatch <- cbind(only_tree, only_seq)

# step 2: correct for sequence names
mismatch <- mismatch %>%
            # remove spaces in country names
            mutate(seq_lab = str_replace_all(mismatch$seq_lab, "\\s", "")) %>%
            # major changes in region
            mutate(seq_lab = case_when(str_detect(seq_lab, "ed'Iv") ~ str_replace(seq_lab, "'", "-"),
                                       str_detect(seq_lab, "Aruba") ~ str_replace(seq_lab, "Aruba", "Netherlands"),
                                       str_detect(seq_lab, "Bonaire") ~ str_replace(seq_lab, "Bonaire", "Netherlands"),
                                       str_detect(seq_lab, "Curacao") ~ str_replace(seq_lab, "Curacao", "Netherlands"),
                                       str_detect(seq_lab, "FrenchGuiana") ~ str_replace(seq_lab, "FrenchGuiana", "Guyane"),
                                       str_detect(seq_lab, "PuertoRico") ~ str_replace(seq_lab, "PuertoRico", "USA"),
                                       TRUE ~ seq_lab)) %>%
            # minor changes in region
            mutate(seq_lab = case_when(str_detect(seq_lab, "Netherlands/AW-RIVM-51693") ~ str_replace(seq_lab, "Netherlands/AW-RIVM-51693", "Aruba/-RIVM-51693"),
                                       str_detect(seq_lab, "Netherlands/AW-RIVM-52747") ~ str_replace(seq_lab, "Netherlands/AW-RIVM-52747", "Aruba/-RIVM-52747"),
                                       str_detect(seq_lab, "Netherlands/BQ-RIVM-51731") ~ str_replace(seq_lab, "Netherlands/BQ-RIVM-51731", "Bonaire/-RIVM-51731"),
                                       str_detect(seq_lab, "Netherlands/BQ-RIVM-51753") ~ str_replace(seq_lab, "Netherlands/BQ-RIVM-51753", "Bonaire/-RIVM-51753"),
                                       str_detect(seq_lab, "Netherlands/BQ-RIVM-51792") ~ str_replace(seq_lab, "Netherlands/BQ-RIVM-51792", "Bonaire/-RIVM-51792"),
                                       str_detect(seq_lab, "SX-RIVM-52857") ~ str_replace(seq_lab, "SX-RIVM-52857", "-RIVM-52857"),
                                       str_detect(seq_lab, "CzechRepublic/CSQ0207") ~ str_replace(seq_lab, "CzechRepublic/CSQ0207", "Czech_Republic/CSQ0207"),
                                       TRUE ~ seq_lab)) %>%
            # corrections for date: 2021 & 2020
            mutate(seq_lab = case_when(str_detect(seq_lab, "CHRF-0356/2020") ~ str_replace(seq_lab, "CHRF-0356/2020", "CHRF-0356/2021"),
                                       str_detect(seq_lab, "AM-FIOCRUZ-21840050SRD/2020") ~ str_replace(seq_lab, "AM-FIOCRUZ-21840050SRD/2020", "AM-FIOCRUZ-21840050SRD/2021"),
                                       str_detect(seq_lab, "Greece/6462/2020") ~ str_replace(seq_lab, "Greece/6462/2020", "Greece/6462/2021"), 
                                       str_detect(seq_lab, "AGU-InDRE_F11762B_S1084/2020") ~ str_replace(seq_lab, "AGU-InDRE_F11762B_S1084/2020", "AGU-InDRE_F11762B_S1084/2021"),
                                       str_detect(seq_lab, "Oman/520278568/2020") ~ str_replace(seq_lab, "Oman/520278568/2020", "Oman/520278568/2021"),
                                       str_detect(seq_lab, "Oman/5211886/2020") ~ str_replace(seq_lab, "Oman/5211886/2020", "Oman/5211886/2021"),
                                       str_detect(seq_lab, "Oman/52180/2020") ~ str_replace(seq_lab, "Oman/52180/2020", "Oman/52180/2021"),
                                       str_detect(seq_lab, "Romania/SC08965/2020") ~ str_replace(seq_lab, "Romania/SC08965/2020", "Romania/SC08965/2021"), #
                                       TRUE ~ seq_lab)) %>%
            # other minor changes in labels
            mutate(seq_lab = case_when(str_detect(seq_lab, "MG-HLAGYN-1853475/2021") ~ str_replace(seq_lab, "MG-HLAGYN-1853475/2021", "GO-HLAGYN-1853475/2021"),
                                       str_detect(seq_lab, "BKE1545-bc17") ~ str_replace(seq_lab, "BKE1545-bc17", "COV-BKE1545/bc17"),
                                       str_detect(seq_lab, "CRIE-L189B0546b") ~ str_replace(seq_lab, "CRIE-L189B0546b", "UA43-CRIE-L189B0546b"),
                                       str_detect(seq_lab, "COA-InDRE-IBT-28845-NC") ~ str_replace(seq_lab, "COA-InDRE-IBT-28845-NC", "COA-InDRE-IBT-28845/NC"),
                                       str_detect(seq_lab, "DUR-InDRE-IBT-34067-NC") ~ str_replace(seq_lab, "DUR-InDRE-IBT-34067-NC", "DUR-InDRE-IBT-34067/NC"),
                                       str_detect(seq_lab, "VD-GEN2699") ~ str_replace(seq_lab, "VD-GEN2699", "GEN2699"),
                                       str_detect(seq_lab, "Kyiv-F2-6") ~ str_replace(seq_lab, "Kyiv-F2-6", "Kyiv/F2-6"),
                                       str_detect(seq_lab, "GA-CDC-3784545-001") ~ str_replace(seq_lab, "GA-CDC-3784545-001", "GA-CDC-5100"),
                                       str_detect(seq_lab, "IL-CDC-02983522-001") ~ str_replace(seq_lab, "IL-CDC-02983522-001", "IL1"),
                                       str_detect(seq_lab, "NH-CDC-03068248-001") ~ str_replace(seq_lab, "NH-CDC-03068248-001", "NH_0033"),
                                       str_detect(seq_lab, "RI-CDC-03070138-001") ~ str_replace(seq_lab, "RI-CDC-03070138-001", "RI-CDC-KCPZ-3781"),
                                       str_detect(seq_lab, "SD-SDPHL-0361/2020") ~ str_replace(seq_lab, "SD-SDPHL-0361/2020", "SD-SDPHL-0361/2021"),
                                       str_detect(seq_lab, "TN-CDC-3981243-001") ~ str_replace(seq_lab, "TN-CDC-3981243-001", "TN-CDC-TX0A-6344"),
                                       str_detect(seq_lab, "VT-CDC-03068154-001") ~ str_replace(seq_lab, "VT-CDC-03068154-001", "VT-CDC-0303"),
                                       TRUE ~ seq_lab))
            
# check 2: all corresponding ones are matched, the rest are ones with no sequence info
length(intersect(mismatch$seq_lab, mismatch$tree_lab)) # 532 mismatches resolved, 7 to be resolved

# step 3: match the ordering of tree_lab with seq_lab in mismatch data set
mismatch <- full_join(mismatch[1], mismatch[2:3], by = c("tree_lab" = "seq_lab")) %>%
            filter(!is.na(tree_lab))

# step 4: change the sequence names to the matched names & ordering of tree tip labels
# join
length(intersect(tree$tip.label, sequence$seqName)) # 2910/3449 matches
sequence <- full_join(sequence, mismatch, by = "GISAID_ID")
# check
sum(!is.na(sequence$tree_lab)) # 532 matched tree_lab & seq_lab + 7 unpaired tree_labs
# sequence %>% filter(is.na(GISAID_ID)) # 7 missing ones with no sequence info
# match names
sequence <- sequence %>% 
            mutate(seqName = ifelse(!is.na(tree_lab),
                                    # has tree_lab means names were mismatched originally
                                    tree_lab,
                                    # use corrected names from mismatch data set
                                    seqName))
                                    # if not, keep original name
# check again
sum(!is.na(sequence$tree_lab)) # 532 matched tree_lab & seq_lab + 7 unpaired tree_labs
sum(!is.na(sequence$seqName)) # 3449 matched tree_lab & seqName
# sequence %>% filter(is.na(GISAID_ID)) # 7 missing ones with no sequence inf
length(intersect(sequence$seqName, tree$tip.label))
      # 3449/3449 matches between sequence name and tree tip label
setequal(sequence$seqName, tree$tip.label) # TRUE
identical(sequence$seqName, tree$tip.label)# FALSE: the order is wrong

# match order between tree tip label and seqName (sequence)
tree_tip_label <- data.frame(seqName = tree$tip.label) # extract ordering of tree tip label
sequence <- full_join(tree_tip_label, sequence, by = "seqName") # join: correct name order
# check again again
identical(sequence$seqName, tree$tip.label) # TRUE
# sequence %>% filter(is.na(GISAID_ID))
      # 7 missing ones with no sequence inf
# remove intermediate data sets
rm(only_seq); rm(only_tree); rm(mismatch); rm(tree_tip_label)
``` 

```{r remove tips with no squence or meta info then merge sequence and meta}
# extract tree tip labels with missing sequence information
noSeq <- sequence$seqName[which(is.na(sequence$GISAID_ID))]
# check tree parameters before removing tips with no sequence information
length(tree$tip.label) # 3449 tips
tree$Nnode # 2827 internal nodes
length(tree$edge.length) # 6275 edges
dim(tree$edge) # (6275, 2)
# remove the tips from the sequence data set
tree <- drop.tip(tree, noSeq, trim.internal = TRUE)
      # Phylogenetic tree with 3442 tips and 2801 internal nodes.
      # Tip labels:
      # hCoV-19/Wuhan/Hu-1/2019, hCoV-19/Wuhan/WH01/2019, hCoV-19/Taiwan/2/2020, 
      # hCoV-19/HongKong/HKPU23_2601/2020, hCoV-19/Thailand/SI200383-NT/2020, 
      # hCoV-19/Australia/VIC03/2020, ...
      # Rooted; includes branch lengths.
# check tree parameters after removing tips with no sequence information
length(tree$tip.label) # 3442 tips (-7 tips)
tree$Nnode # 2801 internal nodes (-26 internal nodes)
length(tree$edge.length) # 6242 edges (-33 edges)
dim(tree$edge) # (6242, 2)
summary(tree$edge.length)
#     Min.    1st Qu.   Median     Mean     3rd Qu.     Max.
# -0.001012  0.027213  0.070801  0.121154  0.167211  1.342243 
sum(tree$edge.length < 0) # 9 edges has negative lengths
sum(tree$edge.length == 0) # 237 edges has negative lengths

# merge sequence with meta & clean the data set for further processing 
sequence <- sequence %>%
            filter(!is.na(GISAID_ID)) %>%
            full_join(meta, by = c("Accession_ID" = "Accession ID")) %>% 
            select(GISAID_ID, seqName, `Virus name`, Accession_ID, variant, 
                   mutation, `Collection date`, Location)
```


### Samples Characteristics

#### Time distribution of sequences

```{r}
# find the time span of the NextStrain subsample
summary(sequence$`Collection date`)
#         Min.      1st Qu.       Median         Mean      3rd Qu.         Max. 
# "2019-12-26" "2021-01-21" "2021-05-28" "2021-03-26" "2021-07-09" "2021-09-03"
```

#### THESIS TAB 1

```{r}
# distribution of E484 mutations in samples and in variants

# proportion of E484 mutations in the NextStrain subsample
rbind(table(E484$AA), round(prop.table(table(E484$AA))*100, 1))

# find the proportion of each variants in each variant
basic <- cbind(c("20I", "20H", "21A, 21I, 21J", "21C", "21D", "20J", "21F", "21B", 
                 "21G", "21H", "other"),
               table(sequence$variant),
               round(prop.table(table(sequence$variant))*100, 1),
               table(sequence$variant, E484$AA)[, 3],
               round(prop.table(table(sequence$variant, E484$AA), margin = 1)*100, 1)[, 3]) %>%
         data.frame()
colnames(basic) <- c("Nextstrain Clade", "Sample Count", "Sample Proportion", 
                     "E484K Count", "E484K Proportion")

basic

# output table to a csv file
# write.csv(basic, file = "basic.csv", row.names = TRUE)

# geographical distribution of E484K - Continent
E484_clade %>% filter(ancestor_state == "K") %>% .$Continent %>% table() %>% prop.table() * 100
E484_clade %>% filter(ancestor_state == "Q") %>% .$Continent %>% table() %>% prop.table() * 100
E484_clade %>% filter(ancestor_state == "A") %>% .$Continent %>% table() %>% prop.table() * 100

# geographical distribution of E484K - Country
E484_clade %>% filter(ancestor_state == "K") %>% .$Country %>% table() %>% prop.table() * 100
E484_clade %>% filter(ancestor_state == "Q") %>% .$Country %>% table() %>% prop.table() * 100
E484_clade %>% filter(ancestor_state == "A") %>% .$Country %>% table() %>% prop.table() * 100
```


### E484 Ancestral State Reconstruction

#### Create a function for ASR and clade identification for specific AA site & ref

```{r function for Ancestral State Reconstruction and clade identification}
find.clade <- function(site, ref){
  
  # vector of mutation represented by AA
  mut_vec <- sequence$mutation # all mutations
  mut_vec <- ifelse(is.na(mut_vec), ref, mut_vec) # no mutation (NA) = ref
  mut_vec <- ifelse(str_detect(mut_vec, paste0("(", site, ")", "([A-Z|-])")), 
                    str_match(mut_vec, paste0("(", site, ")", "([A-Z|-])"))[, 3],
                    # if mutation, extract the substitution
                    ref) # if no mutation pattern found = ref
  
  # vector of mutation represented by integer
  mut_vec <- data.frame(mut_vec)
  names(mut_vec) <- "AA"
  mut_vec <- mut_vec %>% mutate(indAA = AA)
  mut_state <- levels(factor(mut_vec$AA))
  for (s in c(1:length(mut_state))){
    mut_vec$indAA <- ifelse(mut_vec$AA == mut_state[s], s, mut_vec$indAA)
  }
  mut_int <- as.integer(mut_vec$indAA)
  # summary of mutation in sample
  print(table(mut_vec))
  
  # assigned matched names to vector for ASR
  names(mut_int) <- sequence$seqName
  # sanity check
  print(paste0("names matched: ", identical(names(mut_int), tree$tip.label)))
  
  # ASR with castor::asr_mk_model()
  mut_ASR_mk <- asr_mk_model(tree, mut_int, Nstates = length(mut_state), 
                             rate_model = "ER", 
                             include_ancestral_likelihoods = TRUE, 
                             check_input = TRUE)
  
  if (is.null(mut_ASR_mk$ancestral_likelihoods)){
    print(paste0("ASR FAILED: ", site))
  } else{
    # maximal likelihood chosen as states for internal nodes
    mut_likelihood_mk <- mut_ASR_mk$ancestral_likelihoods
    mut_mk <- NaN
    for (i in 1:dim(mut_likelihood_mk)[1]){
      mut_mk[i] = mut_state[which.max(mut_likelihood_mk[i, ])]
    }
    # summary of mutation in ASR nodes
    print(table(mut_mk, useNA = "ifany"))
    
    # vector of AA state on all tips and internal nodes (tips followed by nodes)
    mut_tip_and_node <- c(mut_vec$AA, mut_mk)
    
    # find clades: store the most-recent common ancestor information for each tip
    clade_mut <- data.frame(tip_label = sequence$seqName,
                            tip_node = 1:Ntip(tree), # node number of tips
                            tip_state = mut_vec$AA, # AA state of tree tip
                            ancestor_node = NaN, # will hold ancestor node
                            ancestor_state = NaN, # will hold ASR ancestor node
                            row.names = NULL)
    # find the oldest ancestor (deepest node with the same state) for each tip
    for (tip in clade_mut$tip_node){ 
      # will hold the node number of the oldest ancestor with the same mutation
      find = NaN 
      # loop over and check all ancestors (not just parent) of a tip
      for (ancestor in Ancestors(tree, tip, type = "all")){ 
        # if ancestor node state from ASR = tip state
        if (mut_tip_and_node[ancestor] == mut_tip_and_node[tip]){ 
          # update ancestor if the state of the ancestor node is the same as the tip
          find = ancestor 
        } else{break}
      }
      # if no ancestor matches, use the tip itself
      find <- ifelse(is.na(find), tip, find)
      # match the ancestor and the corresponding tip
      clade_mut$ancestor_node[which(clade_mut$tip_node == tip)] <- find 
      # fill in the ASR state of the ancestor
      clade_mut$ancestor_state[which(clade_mut$tip_node == tip)] <- mut_tip_and_node[find]
    }
    # sanity check
    print(paste0("ancestor matched: ", identical(clade_mut$tip_state, 
                                            clade_mut$ancestor_state)))
    
    # characterize each clade: size, time of emergence, duration
    clade_mut <- clade_mut %>% 
           # size is number of descending tips from each ancestor
           group_by(ancestor_node) %>%
           mutate(size = n()) %>%  
           ungroup() %>% 
           # reorder by AA state of emergence, then by clade size
           select(ancestor_state, ancestor_node, size, tip_node, tip_label) %>%
           arrange(ancestor_state, desc(size)) %>%
           # merge with sequence via tip_label=seqName for sample collection info
           left_join(sequence, by = c("tip_label" = "seqName")) %>%
           # find the earliest and latest sample collection date of each clade
           group_by(ancestor_node) %>% 
           mutate(earliest = min(`Collection date`, na.rm = TRUE)) %>%
           mutate(latest = max(`Collection date`, na.rm = TRUE)) %>%
           mutate(duration = as.numeric(latest - earliest)) %>%
           # find time between samples and the earliest sample (2019-12-26)
           ungroup() %>% 
           # unit = day
           mutate(tip_date_day = `Collection date` - ymd("2019-12-26")) %>%
           # unit = week
           mutate(tip_date_week = time_length(tip_date_day, "weeks")) %>%
           # unit = month
           mutate(tip_date_month = time_length(tip_date_day, "months")) %>%
           mutate(tip_date_day = as.numeric(tip_date_day)) %>%
           # add info of which position the mutation is on
           mutate(mut_pos = site) %>%
           # select useful info
           select(mut_pos, ancestor_state, ancestor_node, size, tip_node, tip_label,
                  variant, mutation, `Collection date`, earliest, duration, Location,
                  tip_date_day, tip_date_week)
    
    # find and characterize emergence events
    emerge_mut <- clade_mut %>% 
            # number of emergence for each AA state
            select(ancestor_state, ancestor_node, size) %>%
            unique() %>%
            group_by(ancestor_state) %>%
            mutate(times = n()) %>%
            ungroup() %>%
            arrange(ancestor_state) %>% 
            mutate(tips = NaN) %>%
            select(ancestor_state, times, ancestor_node, size, tips)
    # find the descending tips from each emergence
    for (anc in emerge_mut$ancestor_node) {
      emerge_mut$tips[which(emerge_mut$ancestor_node == anc)] <- clade_mut %>%
        filter(ancestor_node == anc) %>%
        select(tip_node) %>% unique() %>%
        .$tip_node %>% toString()
    }
    # reorder by emergence frequency, then by clade size
    emerge_mut <- emerge_mut %>% arrange(desc(times), desc(size))
    # add time information to emerge
    temp <- clade_mut %>%
            group_by(ancestor_node) %>%
            select(mut_pos, ancestor_node, earliest, duration) %>%
            unique() %>% ungroup()
    emerge_mut <- emerge_mut %>%
      full_join(temp, by = "ancestor_node") %>%
      select(mut_pos, ancestor_state, times, ancestor_node, 
             size, earliest, duration, tips)
    rm(temp)
    
    # output mutation, clades and emergence information
    return(list(nodeAA = mut_tip_and_node, clade = clade_mut, emerge = emerge_mut))
  }
}
```

#### E484 ASR & Clade Identification

```{r}
# structure of output:
#   $nodeAA - character vector of AA state on tips & at nodes
#   $clade - data frame of tips specifying which clade they belong to
#   $emerge - data frame of emergence/ ancestor nodes (reference + mutated)

E484 <- find.clade("S:E484", "E")
```

#### E484 Reference and Mutated Clades

```{r}
# clades with no E484 mutation
E_clade <- E484$clade %>% filter(ancestor_state == "E")
E_emerge <- E484$emerge %>% filter(ancestor_state == "E")

# clades with any E484 mutation
E484_clade <- E484$clade %>% filter(ancestor_state != "E")
E484_emerge <- E484$emerge %>% filter(ancestor_state != "E")

# find region where E484-mutated clades emerges
# function to extract continent information from Location
continent <- function(x) {  
  str_split(x, "/") [[1]][1] %>% trimws(which = "both")
}
E484_clade$Continent <- sapply(E484_clade$Location, continent)

# function to extract country information from Location
country <- function(x) {  
  str_split(x, "/") [[1]][2] %>% trimws(which = "both")
}
E484_clade$Country <- sapply(E484_clade$Location, country)
```


### E484K Clade Characteristics

#### Statistics of E484 clades (size > 1)

```{r}
# size summary of E484-mutated clades (size > 1)
summary(E484_emerge[which(E484_emerge$size >= 2), ]$size)
#    Min.   1st Qu. Median   Mean  3rd Qu.  Max.
#    2.00    2.75   10.00   39.92   40.75  209.00

# duration summary of E484-mutated clades (size > 1)
summary(E484_emerge[which(E484_emerge$size >= 2), ]$duration)
#    Min.   1st Qu. Median   Mean  3rd Qu.  Max. 
#    5.00   43.25  112.50  130.75  192.75  303.00 

# geographical distribution of sequences for each E484 clade - Continent
for (loc in E484_emerge$ancestor_node[which(E484_emerge$size > 1)]){
  tmp <- E484_clade %>% filter(ancestor_node == loc)
  print(paste0(loc, " ", E484_emerge$ancestor_state[(which(E484_emerge$ancestor_node == loc))]))
  print(cbind(table(tmp$Continent), prop.table(table(tmp$Continent)) * 100))
}

# geographical distribution of sequences for each E484 clade - Country
for (loc in E484_emerge$ancestor_node[which(E484_emerge$size > 1)]){
  tmp <- E484_clade %>% filter(ancestor_node == loc)
  print(paste0(loc, " ", E484_emerge$ancestor_state[(which(E484_emerge$ancestor_node == loc))]))
  print(cbind(table(tmp$Country), prop.table(table(tmp$Country)) * 100))
}

# dominant variants of E484-mutated clades (size > 1)
E484_clade %>% View() %>% filter(ancestor_state == "K") %>% .$variant %>% table()

E484_clade %>% View()
```

#### Statistics of E484 singletons (size == 1)

```{r}
# count of E484-mutated emergence singletons (size == 1)
sum(E484_emerge$size == 1 & E484_emerge$ancestor_state == "K") # 10

# variant of sequences for each E484 clade - Continent
E484_clade %>% filter(ancestor_state == "K") %>% filter(size == 1) %>% .$variant %>% table()

# geographical distribution of sequences for each E484 clade - Continent
for (loc in E484_emerge$ancestor_node[which(E484_emerge$size == 1)]){
  tmp <- E484_clade %>% filter(ancestor_node == loc)
  print(paste0(loc, " ", E484_emerge$ancestor_state[(which(E484_emerge$ancestor_node == loc))]))
  print(cbind(table(tmp$Continent), prop.table(table(tmp$Continent)) * 100))
}

# geographical distribution of sequences for each E484 clade - Country
for (loc in E484_emerge$ancestor_node[which(E484_emerge$size == 1)]){
  tmp <- E484_clade %>% filter(ancestor_node == loc)
  print(paste0(loc, " ", E484_emerge$ancestor_state[(which(E484_emerge$ancestor_node == loc))]))
  print(cbind(table(tmp$Country), prop.table(table(tmp$Country)) * 100))
}
```

#### THESIS FIG 4

```{r}
# plot time distribution of E484 clades
E484_clade %>% 
  arrange(ancestor_state, size) %>%
  ggplot(aes(x = `Collection date`, y = as.factor(ancestor_node))) +
  geom_point(aes(color = as.factor(ancestor_state)), size = 3) +
  scale_colour_manual(name = "E484\nMutation",
                      values = c("blueviolet", "brown3", "goldenrod2")) +
  scale_x_date(breaks = c(date("2020-10-01"), date("2020-12-01"),
                          date("2021-02-01"), date("2021-04-01"), 
                          date("2021-06-01"), date("2021-08-01")),
               date_labels = "%Y %b") + 
  labs(title = "Time Distribution of E484 Mutation Emergence", 
       x = "Collection Date", y = "Ancestor Node") +
  theme(text = element_text(size = 24),
        axis.text.x = element_text(size = 18, hjust = 0),
        axis.text.y = element_text(size = 18),
        legend.text = element_text(size = 18))
```


### E484K Standardized Frequency of Emergence

#### Function to Plot Standardized Frequency of Emergence

```{r plot standardized frequency with vaccine label}
stand.freq.vac <- function(clade, ref, key, color){
  # find tips that are not the first sample of a clade of key mutation
  clade_later <- clade %>%
                 filter(ancestor_state == key) %>%
                 group_by(ancestor_node) %>%
                 filter(`Collection date` != earliest) %>%
                 ungroup() %>%
                 .$tip_node
  
  # find all other nodes and tips
  # excluding tips that are not the first sample of a clade of key mutation
  # excluding tips that are not the reference or the key mutation (other mutations)
  clade_first <- clade %>%
                 filter(!(tip_node %in% clade_later)) %>%
                 filter(ancestor_state %in% c(ref, key))
  
  # create categorical time for each two-week period, range = (0, 88.14)
  clade_first$tip_date_biweek <- cut(clade_first$tip_date_week,
                                     breaks=c(seq(0, 90, 2)),
                                     labels=c(seq(1, 45)))
  clade_first$tip_date_biweek[which(clade_first$tip_date_day == 0)] <- 1
  
  # plot standardized emergence by time (fornights since first sample)
  p <- clade_first %>% 
       group_by(as.factor(tip_date_biweek)) %>%
       mutate(biweek_size = n()) %>% # total eligible samples in two weeks
       mutate(biweek_emerge = sum(ancestor_state == key)) %>% # count emergence
       mutate(biweek_prop = biweek_emerge / biweek_size) %>%
       ungroup() %>%
       ggplot(aes(as.numeric(tip_date_biweek), biweek_prop)) +
       # ref line: Pfizer BioNTech vaccine authorized
       geom_vline(aes(xintercept = time_length(ymd("2020-12-11") - ymd("2019-12-26"), "weeks")/2,
                     color = "Vaccine\nAuthorized"), size = 1.5) +
       geom_smooth(color = color, size = 1.5) +
       geom_point(color = color, size = 3) +
       scale_x_continuous(limits = c(0, 48), breaks = seq(0, 48, 4),
                          labels = c("2019 Dec 26", "2020 Feb 20", "2020 Apr 16", 
                                     "2020 Jun 11", "2020 Aug 06", "2020 Oct 01",
                                     "2020 Nov 26", "2021 Jan 21",
                                     "2021 Mar 18", "2021 May 13", "2021 Jul 08", 
                                     "2021 Sep 02", "2021 Oct 28")) +
       scale_y_continuous(limits = c(0, 0.08)) +
       scale_color_manual(values = c("Vaccine\nAuthorized" = "bisque4"), name = "")  +
       labs(x = "Time of Emergence (Two Weeks)",
            y = "Standardized Frequency of Emergence",
            title = "Standardized Emergence by Time") +
       labs(x = "",
            y = "",
            title = "") +
       theme(text = element_text(size = 14),
             axis.text.x = element_text(size = 14, angle = 30, hjust = 1),
             axis.text.y = element_text(size = 14))
  
  return(p)
}
```

#### THESIS FIG 5
```{r}
# Plot E484K standardized frequency of emergence
E484K_stand_fig5 <- stand.freq.vac(E484$clade, "E", "K", "indianred1")
E484K_stand_fig5
```


### Genetic Background of E484 Clades (Proportion of Other Mutations)

#### Proportion in All E484K Sequences

```{r genetic background at the time of E484 mutation emergence}
# total number of sequences with E484K
K_total <- E484_clade %>% filter(ancestor_state == "K") %>% dim() %>% .[1] # 478
# E484_emerge %>% filter(ancestor_state == "K") %>% .$size %>% sum() # confirm 478 = K_total

# calculate the count and proportion of other mutations in all E484K sequences
other <- E484_clade %>%
         filter(ancestor_state == "K") %>%
         select(mutation) %>% mutate(single = str_split(mutation, ",")) %>% 
         unnest(single) %>% select(single) %>% 
         group_by(single) %>% mutate(count = n()) %>% unique() %>% ungroup() %>%
         arrange(desc(count)) %>% 
         mutate(proportion = count/K_total) %>%
         filter(single != "S:E484K")

# find potential epistatic mutations as: >= 10% percentage among all E484K sequences
key_mut <- other %>% filter(proportion >= 0.1)
```

#### Proportion in Each E484 Clade

```{r}
# define a function to calculate the proportion of specified mutations in each E484K clade
clade_prop <- function(ancestor){
                      # calculate the size of clade descending from an ancestor node
                      size <- E484$emerge$size[which(E484$emerge$ancestor_node == ancestor)]
                      # calculate the proportion of other mutations in this clade
                      prop <- E484$clade %>% 
                              filter(ancestor_node == ancestor) %>%
                              select(mutation) %>% 
                              mutate(single = str_split(mutation, ",")) %>% 
                              unnest(single) %>% select(single) %>% 
                              group_by(single) %>% mutate(clade_count = n()) %>%
                              unique() %>% ungroup() %>%
                              arrange(desc(clade_count)) %>% 
                              mutate(clade_proportion = clade_count/size)
                      # find the proportion of potential_mutation in the clade
                      prop <- prop %>% 
                              full_join(key_mut[, "single"], by = "single") %>%
                              mutate_all(~replace(., is.na(.), 0)) %>%
                              # 0 if no such mutation 
                              filter(single %in% key_mut$single)
                      prop <- key_mut[, "single"] %>% 
                              full_join(prop, by = "single") %>% # reorder
                              select(single, clade_proportion) # remove clade_count
                      # ensure different names for the proportion column of different clades
                      names(prop) <- c("single", paste0("clade_", ancestor))
                      return(prop)
}

# find all ancestor nodes of E484K clade, excluding clades with only 1 tip (size==1)
ancestor_K <- E484_emerge %>% filter(ancestor_state == "K" & size > 1) %>% .$ancestor_node
# find all ancestor nodes of E484Q clade, excluding clades with only 1 tip (size==1)
ancestor_other <- E484_emerge %>% filter(ancestor_state != "K" & size > 1) %>% .$ancestor_node
# find all ancestor nodes of E484E ref clade, excluding clades with only 1 tip (size==1)
ancestor_E <- E_emerge %>% filter(size > 1) %>% .$ancestor_node

# calculate proportion of key_mut in all E484K clades (size > 1)
key_mut_K <- key_mut
for (anc in ancestor_K){
  key_mut_K <- key_mut_K %>% full_join(clade_prop(anc), by = "single")
}
# calculate proportion of key_mut in all E484Q/R clades (size > 1)
key_mut_other <- key_mut
for (anc in ancestor_other){
  key_mut_other <- key_mut_other %>% full_join(clade_prop(anc), by = "single")
}
key_mut_other <- key_mut_other %>% .[ , c(1, 4)] # keep necessary info to merge to key_mut_K
# E484_emerge %>% filter(ancestor_node == 5280) # E484Q-mutated clade
names(key_mut_other) <- c("single", "clade_5280_Q")

# calculate proportion of key_mut in all E484E clades (size > 1)
key_mut_E <- key_mut
for (anc in ancestor_E){
  key_mut_E <- key_mut_E %>% full_join(clade_prop(anc), by = "single")
}
key_mut_E <- key_mut_E %>% .[ , c(1, 4, 5)] # keep necessary info to merge to key_mut_K
names(key_mut_E) <- c("single", "clade_3443_E", "clade_3691_E")
```

#### THESIS FIG 6: heatmap for genetic background of E484 clades

```{r}
# find which variant each clade belongs to
heatmap.label <- c(E484_emerge[which(E484_emerge$size > 1), ]$ancestor_node, 
                   E_emerge[which(E_emerge$size > 1), ]$ancestor_node)
for (hmp in heatmap.label){
  print(hmp); clade %>% filter(ancestor_node == hmp) %>% .$variant %>% table() %>% print()
}
heatmap.label <- c("Gamma\nNode 4399", "Beta/Mu\nNode 3611", "Eta\nNode 3571", "Node 4123", 
                   "Iota\nNode 3975", "Node 4211", "Node 4271", "Node 4102", "Beta\nNode 3681",
                   "Beta\nNode 3712", "Alpha\nNode 4879", "Kappa\nNode 5280", "*\nNode 3443",
                   "Beta\nNode 3691")

# plot heat map to identify potentially interesting mutations
key_mut_K %>%
  full_join(key_mut_other, by = "single") %>%
  full_join(key_mut_E, by = "single") %>%
  pivot_longer(cols = starts_with("clade_"), 
               names_to = "clade", 
               values_to = "clade_proportion") %>%
  mutate(percent = clade_proportion * 100) %>%
  ggplot(aes(fct_inorder(as.factor(clade)), fct_rev(fct_inorder(as.factor(single))))) +
  geom_tile(aes(fill = clade_proportion), color = "grey") +
  scale_fill_gradientn(name = "Proportion", colors = brewer.pal(9, "Reds"), na.value = "grey") +
  scale_x_discrete(position = "top", labels = heatmap.label) +
  labs(x = NULL, y = NULL, title = NULL) +
  theme(text = element_text(size = 14)) +
  theme(legend.position="bottom", legend.margin = margin(t = -8),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12, vjust = 0.8))
```

#### ASR of key mutations N501, N:R203 and N:G204

```{r}
# ASR, clade identification, emergence identification

# structure of output:
#   $nodeAA - character vector of AA state on tips & at nodes
#   $clade - data frame of tips specifying which clade they belong to
#   $emerge - data frame of emergence/ ancestor nodes (reference + mutated)
N501 <- find.clade("S:N501", "N")
R203 <- find.clade("N:R203", "R")
G204 <- find.clade("N:G204", "G")
```


### Phylogenetic Trees

#### Aesthetics for plotting phylogenetic trees
```{r}
# a data frame for all tips and nodes, with E484, N501, G204, R203 status
tip_and_node <- cbind(1:(length(tree$tip.label) + tree$Nnode),
                      E484$nodeAA, N501$nodeAA,
                      G204$nodeAA, R203$nodeAA) %>% 
                data.frame()
names(tip_and_node) <- c("tip_node", "E484", "N501", "G204", "R203")
tip_and_node$tip_node <- as.numeric(tip_and_node$tip_node)

# check
summary(as.factor(tip_and_node$E484))
summary(as.factor(tip_and_node$N501))
summary(as.factor(tip_and_node$G204))
summary(as.factor(tip_and_node$R203))

# data set of all edges: time (edge length), E484 & (S:N501, N:G204R, N:R203K) states
edge_all <- data.frame(tree$edge)
colnames(edge_all) <- c("start", "end")
# add edge length and fix edge length
edge_all <- edge_all %>%
            mutate(time = tree$edge.length) %>%
            mutate(time = case_when(time < 0 ~ abs(time), # (time<0) -> absolute values
                                    time == 0 ~ 0.0000000001, # (time=0) -> 0.0000000001
                                    TRUE ~ time)) %>%
            mutate(time = 365 * time) # change unit from year to day

# add mutation info for the start and end nodes of the edges
edge_all <- edge_all %>% 
            mutate(E484_start = E484$nodeAA[start]) %>% 
            mutate(E484_end = E484$nodeAA[end]) %>%
            mutate(N501_start = N501$nodeAA[start]) %>%
            mutate(N501_end = N501$nodeAA[end]) %>%
            mutate(G204_start = G204$nodeAA[start]) %>% 
            mutate(G204_end = G204$nodeAA[end]) %>%
            mutate(R203_start = R203$nodeAA[start]) %>%
            mutate(R203_end = R203$nodeAA[end])

# define the color of tips and nodes by E484 or N501 substitution
tip_and_node <- tip_and_node %>% 
                mutate(color_E484 = case_when(E484 == "A" ~ "blueviolet",
                                              E484 == "E" ~ "black",
                                              E484 == "K" ~ "brown3",
                                              E484 == "Q" ~ "goldenrod2")) %>%
                mutate(tip_E484 = case_when(E484 == "A" ~ "blueviolet",
                                              E484 == "E" ~ "gray50",
                                              E484 == "K" ~ "brown3",
                                              E484 == "Q" ~ "goldenrod2")) %>%
                mutate(color_N501 = case_when(N501 == "N" ~ "gray50",
                                              N501 == "S" ~ "darkorchid",
                                              N501 == "T" ~ "darkolivegreen4",
                                              N501 == "Y" ~ "steelblue2")) %>%
                mutate(color_G204 = case_when(G204 == "-" ~ "beige",
                                              G204 == "G" ~ "gray50",
                                              G204 == "L" ~ "darkorchid",
                                              G204 == "P" ~ "darkolivegreen4",
                                              G204 == "R" ~ "steelblue2")) %>%
                mutate(color_R203 = case_when(R203 == "-" ~ "beige",
                                              R203 == "I" ~ "darkorchid",
                                              R203 == "K" ~ "steelblue2",
                                              R203 == "M" ~ "darkolivegreen4",
                                              R203 == "R" ~ "gray50",
                                              R203 == "S" ~ "aquamarine4"))

# define the color of edges by E484 or N501 clade
edge_all <- edge_all %>%
            mutate(edge_color_E484K = case_when((E484_start == "K" & E484_end == "K") ~
                                                  "brown3",
                                                (E484_start == "Q" & E484_end == "Q") ~ 
                                                  "goldenrod2",
                                                TRUE ~ "gray50")) %>%
            mutate(edge_color_N501Y = case_when((N501_start == "Y" & N501_end == "Y") ~
                                                  "steelblue2",
                                                (N501_start == "T" & N501_end == "T") ~ 
                                                  "darkolivegreen4",
                                                TRUE ~ "gray50")) %>%
            mutate(edge_color_G204R = case_when((G204_start == "L" & G204_end == "L") ~
                                                  "darkorchid",
                                                (G204_start == "P" & G204_end == "P") ~ 
                                                  "darkolivegreen4",
                                                (G204_start == "R" & G204_end == "R") ~ 
                                                  "steelblue2",
                                                TRUE ~ "gray50")) %>%
            mutate(edge_color_R203K = case_when((R203_start == "K" & R203_end == "K") ~
                                                  "steelblue2",
                                                (R203_start == "M" & R203_end == "M") ~ 
                                                  "darkolivegreen4",
                                                TRUE ~ "gray50"))

# E484-mutated tips
E484_mut_tip <- which(E484$nodeAA[1:length(tree$tip.label)] != "E")
```

#### THESIS FIG 3

```{r}
# plot phylogenetic tree colored by E484 clades
plot(tree, type = "phylogram", direction = "right", show.tip.label = FALSE,
     edge.color = edge_all$edge_color_E484K,
     tip.color = tip_and_node$color_E484[1:3442])
tiplabels(tip = c(1:3442), 
          col = tip_and_node$tip_E484[1:3442], pch = 20, cex = 0.5)
nodelabels(node = E484$emerge$ancestor_node[-1], 
           col = tip_and_node$color_E484[E484$emerge$ancestor_node[-1]], 
           pch = 4, cex =3)
# nodelabels(node = c(E484_emerge$ancestor_node, 3691), 
#            col = tip_and_node$color_E484[c(E484_emerge$ancestor_node, 3691)], 
#            pch = 4, cex = 0.8,
#            text = c(E484_emerge$ancestor_node, 3691), frame = "none")
legend("topleft", inset = c(0.16, 0), cex = 0.8, bty = "n",
       col = c("black", "blueviolet", "brown3", "goldenrod2"), 
       pch = c(16, 16), pt.cex = 1.2, 
       legend = c("E", "E484A", "E484K", "E484Q"))
legend("topleft", inset = c(0.26, 0), cex = 0.8, bty = "n",
       col = "black", pch = 4, pt.cex = 1.2,
       legend = "Emergence")
legend("topleft", inset = c(0, 0), cex = 0.8, bty = "n",
       col = c("gray50", "brown3", "goldenrod2"), lty = c(1, 1), lwd = 2, 
       legend = c("E", "E484K", "E484Q"))
```

#### THESIS FIG 7

```{r}
# plot phylogenetic tree colored by N501 clades
plot(tree, type = "phylogram", direction = "right", show.tip.label = FALSE,
     edge.color = edge_all$edge_color_N501Y,
     tip.color = tip_and_node$color_E484[1:3442])
tiplabels(tip = c(1:3442), 
          col = tip_and_node$tip_E484[1:3442], pch = 20, cex = 0.5)
nodelabels(node = E484$emerge$ancestor_node[-1], 
           col = tip_and_node$color_E484[E484$emerge$ancestor_node[-1]], 
           pch = 4, cex =3)
nodelabels(node = unique(N501$clade$ancestor_node)[-1], 
           col = tip_and_node$color_N501[unique(N501$clade$ancestor_node)[-1]], 
           pch = 3, cex = 2)
legend("topleft", inset = c(0.16, 0), cex = 0.8, bty = "n",
       col = c("black", "gray50", "blueviolet", "brown3", "goldenrod2"), 
       pch = c(4, rep(16, 4)), pt.cex = 1.2, 
       legend = c("E484 Emergence", "E", "E484A", "E484K", "E484Q"))
legend("topleft", inset = c(0.31, 0), cex = 0.8, bty = "n",
       col = c("black", "gray50", "darkorchid", "darkolivegreen4", "steelblue2"), 
       pch = c(3, rep(16, 4)), pt.cex = 1.2,
       legend = c("N501 Emergence", "N", "N501S", "N501T", "N501Y"))
legend("topleft", inset = c(0, 0), cex = 0.8, bty = "n",
       col = c("gray50", "steelblue2"), lty = c(1, 1), lwd = 2, 
       legend = c("N", "N501Y"))
```

#### THESIS FIG S1

```{r}
# plot phylogenetic tree colored by R203 clades
plot(tree, type = "phylogram", direction = "right", show.tip.label = FALSE,
     edge.color = edge_all$edge_color_R203K,
     tip.color = tip_and_node$color_E484[1:3442])
tiplabels(tip = c(1:3442), 
          col = tip_and_node$tip_E484[1:3442], pch = 20, cex = 0.5)
nodelabels(node = E484$emerge$ancestor_node[-1], 
           col = tip_and_node$color_E484[E484$emerge$ancestor_node[-1]], 
           pch = 4, cex =3)
nodelabels(node = unique(R203$clade$ancestor_node)[-14], 
           col = tip_and_node$color_R203[unique(R203$clade$ancestor_node)[-14]], 
           pch = 3, cex = 2)
legend("topleft", inset = c(0.16, 0), cex = 0.8, bty = "n",
       col = c("black", "gray50", "blueviolet", "brown3", "goldenrod2"), 
       pch = c(4, rep(16, 4)), pt.cex = 1.2, 
       legend = c("E484 Emergence", "E", "E484A", "E484K", "E484Q"))
legend("topleft", inset = c(0.31, 0), cex = 0.8, bty = "n",
       col = c("black", "gray50", "beige", "darkorchid", "steelblue2", "darkolivegreen4", "aquamarine4"), 
       pch = c(3, rep(16, 6)), pt.cex = 1.2,
       legend = c("R203 Emergence", "R", "R203-", "R203I", "R203K", "R203M", "R203S"))
legend("topleft", inset = c(0, 0), cex = 0.8, bty = "n",
       col = c("gray50", "steelblue2", "darkolivegreen4"), 
       lty = c(1, 1, 1), lwd = 2, 
       legend = c("R", "R203K", "R203M"))
```

#### THESIS FIG S2

```{r}
# plot phylogenetic tree colored by G204 clades
plot(tree, type = "phylogram", direction = "right", show.tip.label = FALSE,
     edge.color = edge_all$edge_color_G204R,
     tip.color = tip_and_node$color_E484[1:3442])
tiplabels(tip = c(1:3442), 
          col = tip_and_node$tip_E484[1:3442], pch = 20, cex = 0.5)
nodelabels(node = E484$emerge$ancestor_node[-1], 
           col = tip_and_node$color_E484[E484$emerge$ancestor_node[-1]], 
           pch = 4, cex =3)
nodelabels(node = unique(G204$clade$ancestor_node)[-2], 
           col = tip_and_node$color_G204[unique(G204$clade$ancestor_node)[-2]], 
           pch = 3, cex = 2)
legend("topleft", inset = c(0.16, 0), cex = 0.8, bty = "n",
       col = c("black", "gray50", "blueviolet", "brown3", "goldenrod2"), 
       pch = c(4, rep(16, 4)), pt.cex = 1.2, 
       legend = c("E484 Emergence", "E", "E484A", "E484K", "E484Q"))
legend("topleft", inset = c(0.31, 0), cex = 0.8, bty = "n",
       col = c("black", "gray50", "beige", "darkorchid", "darkolivegreen4", "steelblue2"), 
       pch = c(4, rep(16, 5)), pt.cex = 1.2,
       legend = c("G204 Emergence", "G", "G204-", "G204L", "G204P", "G204R"))
legend("topleft", inset = c(0, 0), cex = 0.8, bty = "n",
       col = c("gray50", "darkorchid", "darkolivegreen4", "steelblue2"), 
       lty = c(1, 1), lwd = 2, 
       legend = c("G", "G204L", "G204P", "G204R"))
```


### Epistasis with S:N501Y, S:R203K, N:G204R

#### odds ratio of E484K on nodes with other mutations

```{r}
# numerator is number of emergence (nodes & tips) = E484K
# denominator is number of nodes that are N501Y & N501 & E484K clade ancestral nodes

# for the denominator, find and exclude the set of nodes & tips that are either:
# (1) E484A or E484Q = 1 + 26 = 27 nodes & tips
exclude_E484 <- tip_and_node %>% filter(E484 %in% c("A", "Q")) %>% .$tip_node
# (2) descendants of E484K emergence (not the ancestor of an E484K clade)
# for each E484K ancestral node, find its descendant that's also E484K
for (ancestor in ancestor_K){
  for (descendant in Descendants(tree, ancestor, type = "all")){
    if (tip_and_node$E484[descendant] == "K"){
      exclude_E484 <- c(exclude_E484, descendant)
    }
  }
}
exclude_E484 <- setdiff(exclude_E484, 
                        E484_emerge$ancestor_node[which(E484_emerge$ancestor_state == "K")])
length(exclude_E484) # 905 nodes excluded; denominator only has E484 and E484K ancestral node

# N501Y & N501 background
N501.node.fisher <- tip_and_node %>% 
                    filter(!(tip_node %in% exclude_E484)) %>%
                    filter(N501 %in% c("N", "Y")) %>% 
                    # further exclude nodes & tips not N501 or N501Y
                    select(E484, N501) %>%
                    table() # 5328 nodes & tips left

# R203K & R203 background
R203.node.fisher <- tip_and_node %>% 
                    filter(!(tip_node %in% exclude_E484)) %>%
                    filter(R203 %in% c("R", "K")) %>% 
                    # further exclude nodes & tips not N501 or N501Y
                    select(E484, R203) %>%
                    table() # 3138 nodes & tips left

# G204R & G204 background
G204.node.fisher <- tip_and_node %>% 
                    filter(!(tip_node %in% exclude_E484)) %>%
                    filter(G204 %in% c("G", "R")) %>% 
                    # further exclude nodes & tips not G204 or G204R
                    select(E484, G204) %>%
                    table() # 5265 nodes & tips left

# fisher's exact test
#               unexposed   exposed
# ref (484E)        a          b
# mut (484-sub)     c          d
fisher.test(N501.node.fisher)
fisher.test(R203.node.fisher)
fisher.test(G204.node.fisher)
```

### Sensitivity Analysis

#### THESIS FIG S3a

```{r}
# correlation matrix of E484 clades (by within-clade proportion of other mutations)

# only proportions, no names
key_mut_matrix <- key_mut_K %>%
                  full_join(key_mut_other, by = "single") %>%
                  full_join(key_mut_E, by = "single") %>%
                  select(-c(single, count, proportion)) %>%
                  data.frame()
rownames(key_mut_matrix) <- key_mut_K$single
colnames(key_mut_matrix) <- heatmap.label

# correlation matrix
corrplot(cor(key_mut_matrix), method = "color", order = "original",
         tl.cex = 1.2, cl.cex = 1.2, tl.col="black")
```

#### THESIS FIG S3b

```{r}
# sub-phylogenetic tree from node 3611 (clades 3712 and 3681 embedded)

# extract subtrees from node 3611
subtree_3611 <- extract.clade(tree, 3611)
subtree_3611
length(subtree_3611$tip.label) + subtree_3611$Nnode # 276

# match tree and sub-tree
sub_tip_and_node <- data.frame("tip_node" = c(3611, Descendants(tree, 3611, type = "all")),
                    "sub_tip_node" = c(150, Descendants(subtree_3611, 150, type = "all"))) %>% 
                    arrange(tip_node)
sub_tip_and_node <- inner_join(sub_tip_and_node, tip_and_node, by = "tip_node")
sub_edge_all <- data.frame(subtree_3611$edge)
colnames(sub_edge_all) <- c("sub_start", "sub_end")
sub_edge_all <- sub_edge_all %>%
                mutate(E484_start = sub_tip_and_node$E484[sub_start]) %>%
                mutate(E484_end = sub_tip_and_node$E484[sub_end]) %>%
                mutate(edge_color_E484K = case_when((E484_start == "K" & E484_end == "K") ~
                                                     "brown3",
                                                    (E484_start == "Q" & E484_end == "Q") ~ 
                                                     "goldenrod2",
                                                    TRUE ~ "gray50"))

# plot sub-phylogenetic tree 3611 colored by E484 clades
plot(subtree_3611, type = "phylogram", direction = "right", show.tip.label = FALSE,
     edge.color = sub_edge_all$edge_color_E484K,
     tip.color = sub_tip_and_node$tip_E484[1:149])
tiplabels(tip = c(1:149), 
          col = sub_tip_and_node$tip_E484[1:149], pch = 20, cex = 0.5)
nodelabels(node = sub_tip_and_node$sub_tip_node[which(sub_tip_and_node$tip_node %in%
                                                        E484$emerge$ancestor_node)], 
           col = sub_tip_and_node$color_E484[sub_tip_and_node$sub_tip_node[which(sub_tip_and_node$tip_node %in% E484$emerge$ancestor_node)]], 
           pch = 4, cex =3)
nodelabels(node = c(150, 251, 220), 
           col = "brown3", 
           pch = 4, cex = 0.8,
           text = c(3611, 3712, 3681), frame = "none")
legend("topleft", inset = c(0.16, 0), cex = 0.8, bty = "n",
       col = c("black", "blueviolet", "brown3", "goldenrod2"), 
       pch = c(16, 16), pt.cex = 1.2, 
       legend = c("E", "E484A", "E484K", "E484Q"))
legend("topleft", inset = c(0.26, 0), cex = 0.8, bty = "n",
       col = "black", pch = 4, pt.cex = 1.2,
       legend = "Emergence")
legend("topleft", inset = c(0, 0), cex = 0.8, bty = "n",
       col = c("gray50", "brown3", "goldenrod2"), lty = c(1, 1), lwd = 2, 
       legend = c("E", "E484K", "E484Q"))
```

### END OF RESULTS FOR THESIS